<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Expenses</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body.bill_body { background-color: #e1f1ff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      .main-container { width: 90%; max-width: 1200px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
      .dashboard-title { text-align: center; margin-bottom: 30px; color: #2c3e50; font-size: 2.2em; }
      .dashboard-cards { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 30px; }
      .category-section { margin-top: 20px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
      .section-header { padding: 15px 20px; background-color: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #2c3e50; }
      .section-header:hover { background-color: #e9ecef; }
      .section-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #fff; }
      .section-content.expanded { max-height: 800px; }
      .toggle-icon { transition: transform 0.3s; }
      .toggle-icon.rotated { transform: rotate(90deg); }
      @media (max-width: 768px) { .dashboard-cards { flex-direction: column; } }
      
      /* Added flash message styles */
      .flash-container { position: relative; margin-top: 20px; text-align: center; }
      .custom-flash-message { max-width: 600px; margin: 10px auto; padding: 10px; border-radius: 5px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); opacity: 1; transition: opacity 0.5s ease-out; }
      .alert-danger { background-color: #e74c3c; }
      .alert-warning { background-color: #f39c12; }
      .alert-success { background-color: #2ecc71; }
    </style>
</head>
<body class="bill_body">
  <div class="navbar">
       <div class="logo"> <img src="static/images/logo2.png" alt="Logo" width="82">Expense Tracker</div>
       <div class="nav-links">
         <ul>
            <li><a href="{{ url_for('home') }}">Home</a></li>
            <li><a href="{{ url_for('add') }}">Add Expense</a></li>
            <li><a href="{{ url_for('view') }}">View Expenses</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            {% else %}
                <li><a href="{{ url_for('login') }}">Login</a></li>
            {% endif %}
         </ul>
     </div>
  </div>

  <div class="flash-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="custom-flash-message alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

  <div class="main-container">
    <h2 class="dashboard-title">Bills & Recurring Payments</h2>
    
    <section class="dashboard-cards">
      <div class="card total-card">
        <h3>Total Bills</h3>
        <p>₹{{ "%.2f"|format(total_bill_spending | default(0)) }}</p>
      </div>
      <div class="card expense-count-card">
        <h3>Highest Bill</h3>
        <p>₹{{ "%.2f"|format(highest_bill_expense | default(0)) }}</p>
      </div>
      <div class="card expense-count-card">
        <h3>Total Payments</h3>
        <p>{{ bill_expenses | length if bill_expenses is not none else 0 }}</p>
      </div>
    </section>

    <section>
        {% for category_name, data in category_breakdown.items() %}
            <div class="category-section">
                <div class="section-header" onclick="toggleDetails('{{ category_name | replace(' ', '_') | replace('&', '') }}')">
                    <span>{{ category_name }}</span>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        {% if data.reminders %}
                            <span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em;">
                                {{ data.reminders|length }} Due
                            </span>
                        {% endif %}
                        <span class="category-total">Total Paid: ₹{{ "%.2f"|format(data.total) }}</span>
                        <span class="toggle-icon">&#9654;</span>
                    </div>
                </div>
                
                <div id="{{ category_name | replace(' ', '_') | replace('&', '') }}" class="section-content">
                    
                    {% if data.reminders %}
                    <div style="background-color: #fff3cd; padding: 10px; border-bottom: 1px solid #ffeeba;">
                        <strong style="color: #856404;">⚠️ Upcoming Due Dates:</strong>
                        <ul style="margin: 5px 0 0 20px; color: #856404;">
                            {% for reminder in data.reminders %}
                            <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div>
                                    <strong>₹{{ "%.2f"|format(reminder.amount) }}</strong> due on {{ reminder.due_date }} 
                                    ({{ reminder.days_left }} days left) - <em>{{ reminder.description }}</em>
                                </div>
                                
                                <div style="display: flex; gap: 5px;">
                                    <form method="POST" action="{{ url_for('complete_bill', bill_id=reminder.id) }}" style="display: inline;">
                                        <button type="submit" class="btn" style="padding: 4px 8px; font-size: 0.8em; background-color: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            Mark as Paid
                                        </button>
                                    </form>

                                    <form method="POST" action="{{ url_for('delete_bill', bill_id=reminder.id) }}" style="display: inline;" 
                                          onsubmit="return confirm('Are you sure you want to delete this bill reminder?');">
                                        <button type="submit" class="btn" style="padding: 4px 8px; font-size: 0.8em; background-color: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <div style="padding: 15px; border-bottom: 1px solid #eee; background: #fcfcfc;">
                        <h4 style="margin-top: 0; font-size: 0.9em; color: #555;">Set New Bill Reminder</h4>
                        <form action="{{ url_for('add_bill') }}" method="POST" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="hidden" name="category_id" value="{{ data.target_id }}">
                            
                            <input type="number" name="amount" placeholder="Amount" step="0.01" required style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; width: 100px;">
                            <input type="date" name="due_date" required style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" name="description" placeholder="Desc (e.g. Month Bill)" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1;">
                            <button type="submit" class="btn" style="padding: 6px 15px; font-size: 0.9em; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Set Reminder</button>
                        </form>
                    </div>

                    {% if data.expenses %}
                        <table class="expense-table" style="width: 100%; margin-top: 0;">
                            <thead><tr style="background:#f9f9f9; text-align: left;"><th style="padding:10px;">Date</th><th style="padding:10px;">Desc</th><th style="padding:10px;">Amount</th></tr></thead>
                            <tbody>
                                {% for expense in data.expenses %}
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding:10px;">{{ expense.date }}</td>
                                    <td style="padding:10px;">{{ expense.description }}</td>
                                    <td style="padding:10px; color: #e74c3c; font-weight: bold;">₹{{ "%.2f"|format(expense.amount) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p style="padding: 20px; text-align: center; color: #95a5a6;">No paid bills recorded yet.</p>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </section>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide flash messages after 5 seconds
        const flashMessages = document.querySelectorAll('.custom-flash-message');
        flashMessages.forEach(msg => {
            setTimeout(() => {
                msg.style.opacity = '0';
                // Remove element from DOM after transition
                setTimeout(() => msg.remove(), 500); 
            }, 5000);
        });
    });

    function toggleDetails(id) {
        var content = document.getElementById(id);
        if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
        } else {
            content.classList.add('expanded');
        }
        var header = content.previousElementSibling;
        var icon = header.querySelector('.toggle-icon');
        icon.classList.toggle('rotated');
    }
</script>
</body>
</html>